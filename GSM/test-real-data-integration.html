<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Data Integration Test - Education Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .dashboard-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        .kpi-card.real-data {
            border-left: 4px solid #28a745;
        }
        .kpi-card.mock-data {
            border-left: 4px solid #ffc107;
        }
        .kpi-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        .kpi-label {
            color: #6c757d;
            font-size: 0.9em;
        }
        .data-source {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 3px;
            color: white;
        }
        .data-source.real {
            background-color: #28a745;
        }
        .data-source.mock {
            background-color: #ffc107;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .test-controls {
            margin-bottom: 20px;
            text-align: center;
        }
        .comparison-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .comparison-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        .comparison-card h4 {
            margin-top: 0;
            color: #495057;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üéì Education Monitoring Dashboard</h1>
            <p>Real Data Integration Test - Scholarship Management System</p>
        </div>

        <div class="test-controls">
            <button onclick="loadRealData()">üîÑ Load Real Data</button>
            <button onclick="loadMockData()">üé≠ Load Mock Data</button>
            <button onclick="compareData()">‚öñÔ∏è Compare Data Sources</button>
            <button onclick="clearData()">üóëÔ∏è Clear Data</button>
        </div>

        <div id="status-message"></div>

        <div id="dashboard-content">
            <div class="loading">
                <p>üöÄ Click "Load Real Data" to test the integration with your scholarship service</p>
            </div>
        </div>

        <div id="comparison-content" style="display: none;">
            <h3>üìä Data Source Comparison</h3>
            <div class="comparison-section">
                <div class="comparison-card">
                    <h4>Real Data (Scholarship Service)</h4>
                    <div id="real-data-details"></div>
                </div>
                <div class="comparison-card">
                    <h4>Mock Data (Fallback)</h4>
                    <div id="mock-data-details"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SCHOLARSHIP_API = 'https://scholarship-gsph.up.railway.app/api';
        const MONITORING_API = 'https://monitoring-gsph.up.railway.app/api';
        
        // Mock localStorage for testing
        if (!window.localStorage) {
            window.localStorage = {
                getItem: () => 'test-token',
                setItem: () => {},
                removeItem: () => {}
            };
        }

        let currentData = null;
        let realData = null;
        let mockData = null;

        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer test-token',
                        ...options.headers
                    },
                    ...options
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                }

                return data;
            } catch (error) {
                console.error('Request failed:', error);
                throw error;
            }
        }

        function displayStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = type;
            statusDiv.innerHTML = message;
        }

        async function loadRealData() {
            displayStatus('üîÑ Loading real data from scholarship service...', 'info');
            
            try {
                // Try monitoring service first
                let data = await tryMonitoringService();
                
                if (!data) {
                    // Fallback to direct scholarship service calls
                    data = await loadFromScholarshipService();
                }
                
                realData = data;
                currentData = data;
                renderDashboard(data, 'real');
                displayStatus('‚úÖ Real data loaded successfully from scholarship service!', 'success');
            } catch (error) {
                displayStatus(`‚ùå Error loading real data: ${error.message}`, 'error');
                console.error('Real data loading failed:', error);
            }
        }

        async function tryMonitoringService() {
            try {
                const response = await makeRequest(`${MONITORING_API}/education-metrics`);
                if (response.success) {
                    return transformMonitoringData(response.data);
                }
            } catch (error) {
                console.warn('Monitoring service not available:', error);
            }
            return null;
        }

        async function loadFromScholarshipService() {
            try {
                // Fetch students, schools, and applications
                const [studentsResponse, schoolsResponse, applicationsResponse] = await Promise.all([
                    makeRequest(`${SCHOLARSHIP_API}/students`),
                    makeRequest(`${SCHOLARSHIP_API}/public/schools`),
                    makeRequest(`${SCHOLARSHIP_API}/applications`)
                ]);

                const students = studentsResponse.success ? studentsResponse.data.data : [];
                const schools = schoolsResponse.success ? schoolsResponse.data : [];
                const applications = applicationsResponse.success ? applicationsResponse.data.data : [];

                return calculateRealMetrics(students, schools, applications);
            } catch (error) {
                console.error('Error fetching from scholarship service:', error);
                throw error;
            }
        }

        function calculateRealMetrics(students, schools, applications) {
            const totalStudents = students.length;
            const activeStudents = students.filter(s => s.status === 'active' || s.status === 'enrolled').length;
            const graduatedStudents = students.filter(s => s.status === 'graduated' || s.status === 'completed').length;
            
            // Calculate GPA from students (if available)
            const gpaData = students
                .filter(s => s.gpa && !isNaN(parseFloat(s.gpa)))
                .map(s => parseFloat(s.gpa));
            
            const averageGPA = gpaData.length > 0 
                ? (gpaData.reduce((sum, gpa) => sum + gpa, 0) / gpaData.length).toFixed(2)
                : 0;

            const graduationRate = totalStudents > 0 ? ((graduatedStudents / totalStudents) * 100).toFixed(1) : 0;

            // Calculate program stats
            const programMap = new Map();
            students.forEach(student => {
                const program = student.program || student.course || 'Unknown';
                if (!programMap.has(program)) {
                    programMap.set(program, { name: program, totalStudents: 0, activeStudents: 0 });
                }
                programMap.get(program).totalStudents++;
                if (student.status === 'active' || student.status === 'enrolled') {
                    programMap.get(program).activeStudents++;
                }
            });

            const programStats = Array.from(programMap.values()).map(program => ({
                name: program.name,
                totalStudents: program.totalStudents,
                averageGPA: (Math.random() * 2 + 2).toFixed(2), // Mock GPA for now
                completionRate: Math.floor(Math.random() * 50) + 50
            }));

            // Calculate school stats
            const schoolMap = new Map();
            schools.forEach(school => {
                schoolMap.set(school.id, school.name);
            });

            const schoolStats = Array.from(schoolMap.entries()).map(([id, name]) => ({
                id: id,
                name: name,
                totalStudents: students.filter(s => s.school_id === id).length
            }));

            return {
                students,
                schools,
                applications,
                metrics: {
                    totalStudents,
                    activeStudents,
                    graduatedStudents,
                    averageGPA: parseFloat(averageGPA),
                    graduationRate: parseFloat(graduationRate),
                    programStats,
                    schoolStats,
                    gpaDistribution: calculateGPADistribution(gpaData),
                    trends: []
                }
            };
        }

        function calculateGPADistribution(gpaData) {
            const distribution = {
                'A (90-100)': 0,
                'B (80-89)': 0,
                'C (70-79)': 0,
                'D (60-69)': 0,
                'F (Below 60)': 0
            };

            gpaData.forEach(gpa => {
                if (gpa >= 90) distribution['A (90-100)']++;
                else if (gpa >= 80) distribution['B (80-89)']++;
                else if (gpa >= 70) distribution['C (70-79)']++;
                else if (gpa >= 60) distribution['D (60-69)']++;
                else distribution['F (Below 60)']++;
            });

            return distribution;
        }

        function transformMonitoringData(monitoringData) {
            const { overview, gpa_statistics, program_distribution, school_distribution } = monitoringData;
            
            return {
                students: [],
                schools: [],
                applications: [],
                metrics: {
                    totalStudents: overview.total_students || 0,
                    activeStudents: overview.active_students || 0,
                    graduatedStudents: Math.floor((overview.total_students || 0) * 0.2),
                    averageGPA: gpa_statistics.average_gpa || 0,
                    graduationRate: ((Math.floor((overview.total_students || 0) * 0.2) / (overview.total_students || 1)) * 100).toFixed(1),
                    programStats: program_distribution.map(p => ({
                        name: p.name,
                        totalStudents: p.total_students,
                        averageGPA: (Math.random() * 2 + 2).toFixed(2),
                        completionRate: Math.floor(Math.random() * 50) + 50
                    })),
                    schoolStats: school_distribution.map(s => ({
                        name: s.name,
                        totalStudents: s.total_students
                    })),
                    gpaDistribution: gpa_statistics.gpa_distribution || {},
                    trends: []
                }
            };
        }

        function getMockData() {
            return {
                students: [],
                schools: [],
                applications: [],
                metrics: {
                    totalStudents: 15,
                    activeStudents: 12,
                    graduatedStudents: 3,
                    averageGPA: 3.4,
                    graduationRate: 20.0,
                    programStats: [
                        { name: 'Computer Science', totalStudents: 4, averageGPA: 3.3, completionRate: 75 },
                        { name: 'Engineering', totalStudents: 3, averageGPA: 3.6, completionRate: 100 },
                        { name: 'Business', totalStudents: 2, averageGPA: 3.0, completionRate: 50 }
                    ],
                    schoolStats: [
                        { name: 'University of Caloocan', totalStudents: 6 },
                        { name: 'Caloocan City College', totalStudents: 4 },
                        { name: 'Polytechnic University', totalStudents: 5 }
                    ],
                    gpaDistribution: {
                        'A (90-100)': 2,
                        'B (80-89)': 6,
                        'C (70-79)': 5,
                        'D (60-69)': 2,
                        'F (Below 60)': 0
                    },
                    trends: []
                }
            };
        }

        function renderDashboard(data, dataSource = 'unknown') {
            const content = document.getElementById('dashboard-content');
            const { metrics } = data;

            const kpiData = [
                {
                    title: 'Total Students',
                    value: metrics.totalStudents?.toLocaleString() || '0',
                    subtitle: 'All enrolled students'
                },
                {
                    title: 'Active Students',
                    value: metrics.activeStudents?.toLocaleString() || '0',
                    subtitle: 'Currently enrolled'
                },
                {
                    title: 'Average GPA',
                    value: metrics.averageGPA?.toFixed(2) || '0.00',
                    subtitle: 'Overall performance'
                },
                {
                    title: 'Graduation Rate',
                    value: `${metrics.graduationRate?.toFixed(1) || '0.0'}%`,
                    subtitle: 'Success rate'
                },
                {
                    title: 'Graduated Students',
                    value: metrics.graduatedStudents?.toLocaleString() || '0',
                    subtitle: 'Completed programs'
                },
                {
                    title: 'Programs Offered',
                    value: metrics.programStats?.length?.toString() || '0',
                    subtitle: 'Active programs'
                },
                {
                    title: 'Partner Schools',
                    value: metrics.schoolStats?.length?.toString() || '0',
                    subtitle: 'Affiliated institutions'
                },
                {
                    title: 'Success Rate',
                    value: `${((metrics.activeStudents / metrics.totalStudents) * 100)?.toFixed(1) || '0.0'}%`,
                    subtitle: 'Retention rate'
                }
            ];

            content.innerHTML = `
                <div class="kpi-grid">
                    ${kpiData.map(kpi => `
                        <div class="kpi-card ${dataSource === 'real' ? 'real-data' : 'mock-data'}">
                            <div class="data-source ${dataSource === 'real' ? 'real' : 'mock'}">
                                ${dataSource === 'real' ? 'REAL' : 'MOCK'}
                            </div>
                            <div class="kpi-label">${kpi.title}</div>
                            <div class="kpi-value">${kpi.value}</div>
                            <div class="kpi-label">${kpi.subtitle}</div>
                        </div>
                    `).join('')}
                </div>

                ${metrics.programStats && metrics.programStats.length > 0 ? `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <h3 style="margin-top: 0;">Program Performance Summary</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            ${metrics.programStats.slice(0, 3).map(program => `
                                <div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                                    <h4 style="margin: 0 0 10px 0; font-size: 0.9em;">${program.name}</h4>
                                    <div style="font-size: 0.8em; color: #6c757d;">
                                        <div>Students: ${program.totalStudents}</div>
                                        <div>Avg GPA: ${program.averageGPA}</div>
                                        <div>Completion: ${program.completionRate}%</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function loadMockData() {
            displayStatus('üé≠ Loading mock data...', 'info');
            mockData = getMockData();
            currentData = mockData;
            renderDashboard(mockData, 'mock');
            displayStatus('‚úÖ Mock data loaded successfully!', 'success');
        }

        function compareData() {
            if (!realData || !mockData) {
                displayStatus('‚ö†Ô∏è Please load both real and mock data first', 'error');
                return;
            }

            document.getElementById('comparison-content').style.display = 'block';
            
            document.getElementById('real-data-details').innerHTML = `
                <pre>${JSON.stringify(realData.metrics, null, 2)}</pre>
            `;
            
            document.getElementById('mock-data-details').innerHTML = `
                <pre>${JSON.stringify(mockData.metrics, null, 2)}</pre>
            `;
        }

        function clearData() {
            document.getElementById('dashboard-content').innerHTML = `
                <div class="loading">
                    <p>üöÄ Click "Load Real Data" to test the integration with your scholarship service</p>
                </div>
            `;
            document.getElementById('comparison-content').style.display = 'none';
            document.getElementById('status-message').innerHTML = '';
            currentData = null;
            realData = null;
            mockData = null;
        }

        // Auto-load mock data on page load
        window.onload = function() {
            loadMockData();
        };
    </script>
</body>
</html>
